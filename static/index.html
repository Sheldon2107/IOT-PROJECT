<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ISS Tracker Dashboard</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
html, body {height:100%; margin:0; font-family:sans-serif;}
#map {height:50vh;}
#charts {display:flex; flex-wrap:wrap; gap:20px; padding:10px;}
canvas {background:#0a0e27; border-radius:8px;}
#slider-container {margin:10px;}
#data-table {max-height:300px; overflow:auto;}
table {width:100%; border-collapse:collapse;}
th, td {border:1px solid #ccc; padding:5px;}
</style>
</head>
<body>
<div id="map"></div>

<div id="charts">
<canvas id="latChart" width="400" height="150"></canvas>
<canvas id="lonChart" width="400" height="150"></canvas>
<canvas id="altChart" width="400" height="150"></canvas>
</div>

<div id="slider-container">
<input type="range" id="slider" min="0" max="0" value="0" style="width:80%;">
<button id="playPause">Play/Pause</button>
</div>

<div id="data-table">
<table>
<thead>
<tr><th>Time</th><th>Lat</th><th>Lon</th><th>Alt</th></tr>
</thead>
<tbody id="table-body"></tbody>
</table>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let map = L.map('map').setView([0,0],2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

let marker = L.circleMarker([0,0], {radius:8, color:'red'}).addTo(map);
let polyline = L.polyline([], {color:'blue'}).addTo(map);

let dataPoints = [];
let playing = false;
let slider = document.getElementById('slider');

async function fetchData(){
    const res = await fetch('/api/last3days');
    dataPoints = await res.json();
    slider.max = dataPoints.length-1;
    updateTable();
    updateCharts();
    updateMap();
}

function updateMap(index=undefined){
    let path = dataPoints.map(d=>[d.latitude,d.longitude]);
    polyline.setLatLngs(path);
    if(index===undefined) index = dataPoints.length-1;
    if(dataPoints[index]) {
        marker.setLatLng([dataPoints[index].latitude, dataPoints[index].longitude]);
        map.panTo([dataPoints[index].latitude, dataPoints[index].longitude]);
    }
}

function updateTable(){
    let tbody = document.getElementById('table-body');
    tbody.innerHTML = '';
    dataPoints.forEach(d=>{
        let tr = document.createElement('tr');
        tr.innerHTML = `<td>${d.ts_utc}</td><td>${d.latitude.toFixed(4)}</td><td>${d.longitude.toFixed(4)}</td><td>${d.altitude.toFixed(2)}</td>`;
        tbody.appendChild(tr);
    });
}

// Charts
let latChart = new Chart(document.getElementById('latChart').getContext('2d'), {
    type:'line', data:{labels:[], datasets:[{label:'Latitude',data:[],borderColor:'cyan',fill:false}]}, options:{scales:{x:{display:false}}}
});
let lonChart = new Chart(document.getElementById('lonChart').getContext('2d'), {
    type:'line', data:{labels:[], datasets:[{label:'Longitude',data:[],borderColor:'orange',fill:false}]}, options:{scales:{x:{display:false}}}
});
let altChart = new Chart(document.getElementById('altChart').getContext('2d'), {
    type:'line', data:{labels:[], datasets:[{label:'Altitude',data:[],borderColor:'lime',fill:false}]}, options:{scales:{x:{display:false}}}
});

function updateCharts(){
    let labels = dataPoints.map(d=>d.ts_utc);
    latChart.data.labels = labels; latChart.data.datasets[0].data = dataPoints.map(d=>d.latitude); latChart.update();
    lonChart.data.labels = labels; lonChart.data.datasets[0].data = dataPoints.map(d=>d.longitude); lonChart.update();
    altChart.data.labels = labels; altChart.data.datasets[0].data = dataPoints.map(d=>d.altitude); altChart.update();
}

// Slider + play/pause
let playBtn = document.getElementById('playPause');
let currentIndex = 0;
playBtn.onclick = ()=>{playing=!playing; playBtn.innerText = playing?'Pause':'Play';};
slider.oninput = ()=>{currentIndex = parseInt(slider.value); updateMap(currentIndex);};

setInterval(()=>{
    if(playing){
        currentIndex++; if(currentIndex>=dataPoints.length) currentIndex=0;
        slider.value = currentIndex;
        updateMap(currentIndex);
    }
},500);

fetchData();
</script>
</body>
</html>
